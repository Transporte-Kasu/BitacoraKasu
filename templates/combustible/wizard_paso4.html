{% extends 'base.html' %}
{% load static %}

{% block title %}Paso 4: Proceso de Carga{% endblock %}

{% block body_class %}wizard-page{% endblock %}

{% block extra_css %}
<style>
    .navbar-menu{display:none}
    body { background: #f3f4f6; }
    .timer-display {
        font-size: 3rem;
        font-weight: bold;
        font-family: 'Courier New', monospace;
        color: #1f2937;
    }
    .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: .5; }
    }
    .loading-dots span {
        animation: loading 1.4s infinite;
    }
    .loading-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    .loading-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    @keyframes loading {
        0%, 80%, 100% { opacity: 0; }
        40% { opacity: 1; }
    }
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen pb-20">
    <!-- Barra de progreso -->
    <div class="bg-white shadow-sm sticky top-0 z-10">
        <div class="px-4 py-4">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-semibold text-gray-800">Paso {{ paso }} de {{ total_pasos }}</h2>
                <span class="text-sm text-gray-600">{{ progreso }}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300 progress-bar"
                     style="width: {{ progreso }}%"></div>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="px-4 py-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-100 rounded-full mb-4">
                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Proceso de Carga</h1>
                <p class="text-gray-600">Inicia y monitorea el despacho de combustible</p>
            </div>

            <!-- Resumen de la unidad -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">üìã Resumen</h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-gray-600">Unidad:</span>
                        <span class="font-semibold text-gray-900 ml-2">{{ carga.unidad.numero_economico }}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Tipo:</span>
                        <span class="font-semibold text-gray-900 ml-2">{{ carga.unidad.get_tipo_display }}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Kilometraje:</span>
                        <span class="font-semibold text-gray-900 ml-2">{{ carga.kilometraje_actual|floatformat:0 }} km</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Nivel inicial:</span>
                        <span class="font-semibold text-gray-900 ml-2">{{ carga.get_nivel_combustible_inicial_display }}</span>
                    </div>
                </div>
            </div>

            <form method="post" id="paso4Form" data-carga-id="{{ carga.id }}">
                {% csrf_token %}

                <!-- Secci√≥n 1: Cron√≥metro (Primer paso) -->
                <div id="section-timer" class="mb-6">
                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg p-6 border-2 border-purple-200">
                        <h3 class="text-center text-lg font-semibold text-gray-800 mb-4">‚è±Ô∏è Paso 1: Control de Tiempo</h3>

                        <!-- Display del cron√≥metro -->
                        <div class="text-center mb-6">
                            <div id="timer-display" class="timer-display text-purple-600">00:00:00</div>
                            <p class="text-sm text-gray-600 mt-2">
                                <span id="timer-status">Presiona "Iniciar" cuando comience el despacho</span>
                            </p>
                        </div>

                        <!-- Botones de control -->
                        <div id="timer-controls">
                            <button type="button" id="startBtn"
                                    class="w-full px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-lg shadow-lg">
                                <span class="flex items-center justify-center">
                                    <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                                    </svg>
                                    Iniciar Despacho
                                </span>
                            </button>

                            <button type="button" id="stopBtn" style="display: none;"
                                    class="w-full px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-bold text-lg shadow-lg">
                                <span class="flex items-center justify-center">
                                    <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path>
                                    </svg>
                                    Finalizar Despacho
                                </span>
                            </button>
                        </div>

                        <!-- Estado de carga -->
                        <div id="loading-indicator" style="display: none;" class="text-center mt-4">
                            <div class="inline-flex items-center px-4 py-2 bg-purple-100 rounded-full">
                                <div class="loading-dots flex space-x-1 mr-3">
                                    <span class="w-2 h-2 bg-purple-600 rounded-full"></span>
                                    <span class="w-2 h-2 bg-purple-600 rounded-full"></span>
                                    <span class="w-2 h-2 bg-purple-600 rounded-full"></span>
                                </div>
                                <span class="text-sm font-medium text-purple-800">Despacho en proceso</span>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n del paso 1 -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
                        <h4 class="font-semibold text-blue-900 mb-2">‚ÑπÔ∏è Instrucciones</h4>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>‚Ä¢ Presiona "Iniciar Despacho" cuando el combustible comience a fluir</li>
                            <li>‚Ä¢ El cron√≥metro registrar√° el tiempo autom√°ticamente</li>
                            <li>‚Ä¢ Cuando termine la carga, presiona "Finalizar Despacho"</li>
                            <li>‚Ä¢ Despu√©s podr√°s ingresar los litros dispensados</li>
                        </ul>
                    </div>
                </div>

                <!-- Secci√≥n 2: Cantidad de litros (Aparece despu√©s de finalizar) -->
                <div id="section-litros" style="display: none;" class="mb-6 fade-in">
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-6 border-2 border-green-200">
                        <h3 class="text-center text-lg font-semibold text-gray-800 mb-4">‚õΩ Paso 2: Cantidad Despachada</h3>

                        <!-- Resumen del tiempo -->
                        <div class="bg-white rounded-lg p-4 mb-4 text-center">
                            <p class="text-sm text-gray-600 mb-1">Tiempo de despacho registrado:</p>
                            <p class="text-2xl font-bold text-green-600" id="tiempo-registrado">--:--:--</p>
                        </div>

                        <!-- Campo de litros -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path>
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"></path>
                                    </svg>
                                    Ingresa los litros mostrados en la bomba
                                </span>
                            </label>
                            {{ form.cantidad_litros }}
                            {% if form.cantidad_litros.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.cantidad_litros.errors.0 }}</p>
                            {% endif %}
                            <p class="mt-2 text-xs text-gray-500 text-center">
                                üí° Verifica la cantidad exacta en el display de la bomba
                            </p>
                        </div>
                    </div>

                    <!-- Informaci√≥n del paso 2 -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
                        <h4 class="font-semibold text-green-900 mb-2">‚úì √öltimo paso</h4>
                        <p class="text-sm text-green-800">
                            Ingresa la cantidad exacta de litros que muestra la bomba dispensadora y presiona "Continuar" para avanzar al siguiente paso.
                        </p>
                    </div>
                </div>

                <!-- Botones de navegaci√≥n -->
                <div class="flex gap-3">
                    <a href="{% url 'combustible:wizard' paso=3 %}"
                       class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-center font-medium">
                        ‚Üê Atr√°s
                    </a>
                    <button type="submit" id="submitBtn" disabled
                            class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium disabled:bg-gray-300 disabled:cursor-not-allowed">
                        Continuar ‚Üí
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let timerInterval = null;
    let startTime = null;
    let isRunning = false;
    let timerFinished = false;
    let cargaId = document.getElementById('paso4Form').dataset.cargaId;

    const timerDisplay = document.getElementById('timer-display');
    const timerStatus = document.getElementById('timer-status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const submitBtn = document.getElementById('submitBtn');
    const loadingIndicator = document.getElementById('loading-indicator');
    const cantidadInput = document.getElementById('id_cantidad_litros');
    const sectionTimer = document.getElementById('section-timer');
    const sectionLitros = document.getElementById('section-litros');
    const tiempoRegistrado = document.getElementById('tiempo-registrado');

    function formatTime(seconds) {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updateTimer() {
        if (!isRunning) return;
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerDisplay.textContent = formatTime(elapsed);
    }

    // Bot√≥n Iniciar Despacho
    startBtn.addEventListener('click', function() {
        startTime = Date.now();
        isRunning = true;

        timerInterval = setInterval(updateTimer, 1000);

        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        loadingIndicator.style.display = 'block';
        timerStatus.textContent = 'Despacho en proceso...';
        timerDisplay.classList.add('pulse-animation');

        // Llamada AJAX para registrar inicio
        fetch(`/combustible/${cargaId}/iniciar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        }).then(response => response.json())
          .then(data => {
              console.log('Inicio registrado:', data);
          })
          .catch(error => {
              console.error('Error al registrar inicio:', error);
          });
    });

    // Bot√≥n Finalizar Despacho
    stopBtn.addEventListener('click', function() {
        isRunning = false;
        clearInterval(timerInterval);
        timerFinished = true;

        const tiempoFinal = timerDisplay.textContent;

        stopBtn.style.display = 'none';
        loadingIndicator.style.display = 'none';
        timerStatus.textContent = '‚úì Despacho completado';
        timerDisplay.classList.remove('pulse-animation');
        timerDisplay.classList.add('text-green-600');

        // Llamada AJAX para registrar fin
        fetch(`/combustible/${cargaId}/finalizar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        }).then(response => response.json())
          .then(data => {
              if (data.status === 'success') {
                  // Mostrar secci√≥n de litros
                  sectionLitros.style.display = 'block';
                  tiempoRegistrado.textContent = tiempoFinal + ` (${data.tiempo_total} min)`;

                  // Scroll suave a la secci√≥n de litros
                  setTimeout(() => {
                      sectionLitros.scrollIntoView({ behavior: 'smooth', block: 'start' });
                      cantidadInput.focus();
                  }, 300);
              }
          })
          .catch(error => {
              console.error('Error al registrar finalizaci√≥n:', error);
              alert('Hubo un error al registrar el fin del despacho. Por favor intenta de nuevo.');
          });
    });

    // Validar campo de litros antes de habilitar bot√≥n continuar
    cantidadInput.addEventListener('input', function() {
        if (timerFinished && this.value && parseFloat(this.value) > 0) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    });

    // Prevenir env√≠o del formulario si no se han completado los pasos
    document.getElementById('paso4Form').addEventListener('submit', function(e) {
        if (!timerFinished) {
            e.preventDefault();
            alert('Debes completar el proceso de despacho primero');
            return false;
        }

        if (!cantidadInput.value || parseFloat(cantidadInput.value) <= 0) {
            e.preventDefault();
            alert('Debes ingresar la cantidad de litros despachados');
            cantidadInput.focus();
            return false;
        }
    });
</script>
{% endblock %}