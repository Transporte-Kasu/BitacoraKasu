<!-- wizard_paso5.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Paso 5: Candado Nuevo{% endblock %}

{% block body_class %}wizard-page{% endblock %}

{% block extra_css %}
<style>
    .navbar-menu{display:none}
    body { background: #f3f4f6; }
    .preview-image { max-width: 100%; height: auto; border-radius: 0.5rem; }
    .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }
    .preview-item { position: relative; border-radius: 0.5rem; overflow: hidden; border: 2px solid #e5e7eb; }
    .preview-item img { width: 100%; height: 140px; object-fit: cover; }
    .preview-item .remove-btn {
        position: absolute; top: 4px; right: 4px;
        background: rgba(239,68,68,0.9); color: white; border: none;
        border-radius: 50%; width: 28px; height: 28px; cursor: pointer;
        font-size: 14px; display: flex; align-items: center; justify-content: center;
    }
    .preview-item .photo-label {
        position: absolute; bottom: 0; left: 0; right: 0;
        background: rgba(0,0,0,0.6); color: white;
        font-size: 11px; padding: 2px 6px; text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen pb-20">
    <div class="bg-white shadow-sm sticky top-0 z-10">
        <div class="px-4 py-4">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-semibold text-gray-800">Paso {{ paso }} de {{ total_pasos }}</h2>
                <span class="text-sm text-gray-600">{{ progreso }}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300 progress-bar"
                     style="width: {{ progreso }}%"></div>
            </div>
        </div>
    </div>

    <div class="px-4 py-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Candado Nuevo</h1>
                <p class="text-gray-600">Instala y fotografía los candados de seguridad nuevos</p>
            </div>

            <form method="post" enctype="multipart/form-data" id="paso5Form">
                {% csrf_token %}

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Fotografías de los candados nuevos instalados</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center bg-gray-50">
                        <div id="preview-container" class="hidden mb-4">
                            <div id="preview-grid" class="preview-grid"></div>
                        </div>
                        <div id="photo-counter" class="hidden mb-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                <span id="counter-text">0 fotos seleccionadas</span>
                            </span>
                        </div>
                        <label for="id_fotos_candado_nuevo" class="cursor-pointer">
                            <div class="inline-flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span id="btn-text">Tomar Fotos de Candados Nuevos</span>
                            </div>
                        </label>
                        {{ form.fotos_candado_nuevo }}
                        <p class="text-xs text-gray-500 mt-2">Toma una foto por cada candado. Puedes agregar varias.</p>
                    </div>
                    {% if form.fotos_candado_nuevo.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.fotos_candado_nuevo.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="flex gap-3">
                    <a href="{% url 'combustible:wizard' paso=4 %}"
                       class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-center font-medium">
                        ← Atrás
                    </a>
                    <button type="submit" id="submitBtn" disabled
                            class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium disabled:bg-gray-300 disabled:cursor-not-allowed">
                        Continuar →
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <h3 class="font-semibold text-green-900 mb-2 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                Instrucciones
            </h3>
            <ul class="text-sm text-green-800 space-y-1">
                <li>• Instala los candados nuevos correctamente</li>
                <li>• Verifica que estén bien cerrados</li>
                <li>• Fotografía cada candado instalado</li>
                <li>• Asegura que los números sean visibles</li>
                <li>• Si hay más de un tanque, toma una foto por cada candado</li>
            </ul>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('id_fotos_candado_nuevo');
    const previewContainer = document.getElementById('preview-container');
    const previewGrid = document.getElementById('preview-grid');
    const photoCounter = document.getElementById('photo-counter');
    const counterText = document.getElementById('counter-text');
    const btnText = document.getElementById('btn-text');
    const submitBtn = document.getElementById('submitBtn');

    // Configurar input para abrir cámara directamente en móvil
    fileInput.removeAttribute('multiple');
    fileInput.setAttribute('capture', 'environment');

    // Almacenar fotos como data URLs en memoria para evitar que las
    // referencias File se invaliden al reutilizar el input en móvil
    let capturedPhotos = []; // [{dataUrl, name, type}, ...]

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            capturedPhotos.push({
                dataUrl: event.target.result,
                name: file.name,
                type: file.type
            });
            updatePreviews();
        };
        reader.readAsDataURL(file);
    });

    function updatePreviews() {
        previewGrid.innerHTML = '';

        if (capturedPhotos.length === 0) {
            previewContainer.classList.add('hidden');
            photoCounter.classList.add('hidden');
            btnText.textContent = 'Tomar Fotos de Candados Nuevos';
            submitBtn.disabled = true;
            return;
        }

        capturedPhotos.forEach((photo, index) => {
            const item = document.createElement('div');
            item.className = 'preview-item';
            item.innerHTML = `
                <img src="${photo.dataUrl}" alt="Candado ${index + 1}">
                <button type="button" class="remove-btn" data-index="${index}" title="Eliminar">&times;</button>
                <div class="photo-label">Candado ${index + 1}</div>
            `;
            previewGrid.appendChild(item);

            item.querySelector('.remove-btn').addEventListener('click', function() {
                capturedPhotos.splice(parseInt(this.dataset.index), 1);
                updatePreviews();
            });
        });

        previewContainer.classList.remove('hidden');
        photoCounter.classList.remove('hidden');
        counterText.textContent = capturedPhotos.length === 1
            ? '1 foto tomada'
            : `${capturedPhotos.length} fotos tomadas`;
        btnText.textContent = 'Tomar Otra Foto';
        submitBtn.disabled = false;
    }

    // Convertir data URL a Blob para enviar al servidor
    function dataUrlToBlob(dataUrl) {
        const parts = dataUrl.split(',');
        const mime = parts[0].match(/:(.*?);/)[1];
        const bstr = atob(parts[1]);
        const u8arr = new Uint8Array(bstr.length);
        for (let i = 0; i < bstr.length; i++) {
            u8arr[i] = bstr.charCodeAt(i);
        }
        return new Blob([u8arr], { type: mime });
    }

    document.getElementById('paso5Form').addEventListener('submit', function(e) {
        e.preventDefault();

        if (capturedPhotos.length === 0) {
            alert('Debes tomar al menos una foto del candado nuevo.');
            return;
        }

        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', this.querySelector('[name=csrfmiddlewaretoken]').value);

        capturedPhotos.forEach((photo, i) => {
            const blob = dataUrlToBlob(photo.dataUrl);
            formData.append('fotos_candado_nuevo', blob, photo.name || 'candado_' + (i + 1) + '.jpg');
        });

        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';

        fetch(this.action || window.location.href, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text().then(html => {
                    document.open();
                    document.write(html);
                    document.close();
                });
            }
        }).catch(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Continuar →';
            alert('Error al enviar. Verifica tu conexión e intenta de nuevo.');
        });
    });
</script>
{% endblock %}