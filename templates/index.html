{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard Principal{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid;
    }
    .chart-container {
        position: relative;
        height: 300px;
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">üìä Dashboard Principal - ProyectoKasu</h1>
    
    <!-- Resumen Ejecutivo -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Operadores -->
        <div class="stat-card" style="border-color: #3b82f6;">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-gray-600">Operadores</p>
                    <p class="text-3xl font-bold text-gray-900">{{ operadores_activos }}</p>
                    <p class="text-xs text-gray-500">de {{ total_operadores }} total</p>
                </div>
                <span class="text-4xl">üë§</span>
            </div>
        </div>
        
        <!-- Unidades -->
        <div class="stat-card" style="border-color: #f59e0b;">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-gray-600">Unidades</p>
                    <p class="text-3xl font-bold text-gray-900">{{ unidades_activas }}</p>
                    <p class="text-xs text-gray-500">{{ unidades_en_taller }} en taller</p>
                </div>
                <span class="text-4xl">üöõ</span>
            </div>
        </div>
        
        <!-- Viajes -->
        <div class="stat-card" style="border-color: #10b981;">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-gray-600">Viajes (mes)</p>
                    <p class="text-3xl font-bold text-gray-900">{{ viajes_ultimo_mes }}</p>
                    <p class="text-xs text-gray-500">{{ viajes_en_curso }} en curso</p>
                </div>
                <span class="text-4xl">üìã</span>
            </div>
        </div>
        
        <!-- Combustible -->
        <div class="stat-card" style="border-color: #8b5cf6;">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-gray-600">Combustible (hoy)</p>
                    <p class="text-3xl font-bold text-gray-900">{{ total_litros_hoy|floatformat:0 }}</p>
                    <p class="text-xs text-gray-500">litros cargados</p>
                </div>
                <span class="text-4xl">‚õΩ</span>
            </div>
        </div>
    </div>
    
    <!-- Segunda fila de estad√≠sticas -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Taller -->
        <div class="stat-card" style="border-color: #ef4444;">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-gray-600">√ìrdenes Taller</p>
                    <p class="text-3xl font-bold text-gray-900">{{ ordenes_taller_pendientes }}</p>
                    <p class="text-xs text-gray-500">pendientes</p>
                </div>
                <span class="text-4xl">üîß</span>
            </div>
        </div>
        
        <!-- Compras -->
        <div class="stat-card" style="border-color: #ec4899;">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-gray-600">Requisiciones</p>
                    <p class="text-3xl font-bold text-gray-900">{{ requisiciones_pendientes }}</p>
                    <p class="text-xs text-gray-500">{{ ordenes_compra_activas }} OC activas</p>
                </div>
                <span class="text-4xl">üõí</span>
            </div>
        </div>
        
        <!-- Almac√©n -->
        <div class="stat-card" style="border-color: #06b6d4;">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-gray-600">Productos</p>
                    <p class="text-3xl font-bold text-gray-900">{{ productos_almacen }}</p>
                    <p class="text-xs text-red-600">{{ productos_stock_bajo }} con stock bajo</p>
                </div>
                <span class="text-4xl">üì¶</span>
            </div>
        </div>
        
        <!-- Valor Inventario -->
        <div class="stat-card" style="border-color: #14b8a6;">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-gray-600">Valor Inventario</p>
                    <p class="text-2xl font-bold text-gray-900">${{ valor_inventario|floatformat:0 }}</p>
                    <p class="text-xs text-gray-500">{{ alertas_almacen }} alertas</p>
                </div>
                <span class="text-4xl">üí∞</span>
            </div>
        </div>
    </div>
    
    <!-- Alertas Cr√≠ticas -->
    {% if alertas_criticas %}
    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-8 rounded">
        <div class="flex items-start">
            <span class="text-2xl mr-3">‚ö†Ô∏è</span>
            <div class="flex-1">
                <h3 class="font-bold text-red-800 mb-2">Alertas Cr√≠ticas del Almac√©n</h3>
                <ul class="space-y-1">
                    {% for alerta in alertas_criticas %}
                    <li class="text-sm text-red-700">
                        <strong>{{ alerta.producto_almacen.sku }}</strong>: {{ alerta.mensaje }}
                    </li>
                    {% endfor %}
                </ul>
                <a href="{% url 'almacen:alerta_list' %}" class="text-red-800 hover:underline text-sm mt-2 inline-block">Ver todas las alertas ‚Üí</a>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Gr√°ficas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Viajes por d√≠a -->
        <div class="chart-container">
            <h3 class="font-bold text-gray-700 mb-4">üìà Viajes por D√≠a (√∫ltimos 7 d√≠as)</h3>
            <canvas id="chartViajes"></canvas>
        </div>
        
        <!-- Combustible por d√≠a -->
        <div class="chart-container">
            <h3 class="font-bold text-gray-700 mb-4">‚õΩ Combustible por D√≠a (√∫ltimos 7 d√≠as)</h3>
            <canvas id="chartCombustible"></canvas>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Estado de Unidades -->
        <div class="chart-container">
            <h3 class="font-bold text-gray-700 mb-4">üöõ Estado de Unidades</h3>
            <canvas id="chartUnidades"></canvas>
        </div>
        
        <!-- Top Categor√≠as Almac√©n -->
        <div class="chart-container">
            <h3 class="font-bold text-gray-700 mb-4">üì¶ Top 5 Categor√≠as en Almac√©n</h3>
            <canvas id="chartCategorias"></canvas>
        </div>
    </div>
    
    <!-- Accesos R√°pidos -->
    <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üöÄ Accesos R√°pidos a M√≥dulos</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
            <a href="{% url 'operadores:dashboard' %}" class="text-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition">
                <div class="text-3xl mb-2">üë§</div>
                <div class="text-xs font-medium">Operadores</div>
            </a>
            <a href="{% url 'unidades:dashboard' %}" class="text-center p-4 bg-orange-50 hover:bg-orange-100 rounded-lg transition">
                <div class="text-3xl mb-2">üöõ</div>
                <div class="text-xs font-medium">Unidades</div>
            </a>
            <a href="{% url 'bitacoras:dashboard' %}" class="text-center p-4 bg-green-50 hover:bg-green-100 rounded-lg transition">
                <div class="text-3xl mb-2">üìã</div>
                <div class="text-xs font-medium">Bit√°coras</div>
            </a>
            <a href="{% url 'combustible:dashboard' %}" class="text-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition">
                <div class="text-3xl mb-2">‚õΩ</div>
                <div class="text-xs font-medium">Combustible</div>
            </a>
            <a href="{% url 'taller:dashboard' %}" class="text-center p-4 bg-red-50 hover:bg-red-100 rounded-lg transition">
                <div class="text-3xl mb-2">üîß</div>
                <div class="text-xs font-medium">Taller</div>
            </a>
            <a href="{% url 'compras:dashboard' %}" class="text-center p-4 bg-pink-50 hover:bg-pink-100 rounded-lg transition">
                <div class="text-3xl mb-2">üõí</div>
                <div class="text-xs font-medium">Compras</div>
            </a>
            <a href="{% url 'almacen:dashboard' %}" class="text-center p-4 bg-cyan-50 hover:bg-cyan-100 rounded-lg transition">
                <div class="text-3xl mb-2">üì¶</div>
                <div class="text-xs font-medium">Almac√©n</div>
            </a>
            <a href="{% url 'admin:index' %}" class="text-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition">
                <div class="text-3xl mb-2">‚öôÔ∏è</div>
                <div class="text-xs font-medium">Admin</div>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Configuraci√≥n de Chart.js en espa√±ol
Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';
Chart.defaults.color = '#6b7280';

// Gr√°fica de Viajes
const ctxViajes = document.getElementById('chartViajes').getContext('2d');
new Chart(ctxViajes, {
    type: 'line',
    data: {
        labels: {{ labels_dias|safe }},
        datasets: [{
            label: 'Viajes',
            data: {{ viajes_por_dia|safe }},
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
    }
});

// Gr√°fica de Combustible
const ctxCombustible = document.getElementById('chartCombustible').getContext('2d');
new Chart(ctxCombustible, {
    type: 'bar',
    data: {
        labels: {{ labels_dias|safe }},
        datasets: [{
            label: 'Litros',
            data: {{ combustible_por_dia|safe }},
            backgroundColor: '#8b5cf6'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// Gr√°fica de Estado de Unidades
const ctxUnidades = document.getElementById('chartUnidades').getContext('2d');
new Chart(ctxUnidades, {
    type: 'doughnut',
    data: {
        labels: ['Activas', 'Inactivas'],
        datasets: [{
            data: [{{ unidades_activas_count }}, {{ unidades_inactivas_count }}],
            backgroundColor: ['#10b981', '#ef4444']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Gr√°fica de Top Categor√≠as
const ctxCategorias = document.getElementById('chartCategorias').getContext('2d');
new Chart(ctxCategorias, {
    type: 'bar',
    data: {
        labels: [
            {% for cat in top_categorias_almacen %}'{{ cat.categoria|truncatechars:20 }}'{% if not forloop.last %},{% endif %}{% endfor %}
        ],
        datasets: [{
            label: 'Productos',
            data: [
                {% for cat in top_categorias_almacen %}{{ cat.count }}{% if not forloop.last %},{% endif %}{% endfor %}
            ],
            backgroundColor: '#06b6d4'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: { beginAtZero: true }
        }
    }
});
</script>
{% endblock %}
